---
- name: Create NetBox contact from Star Wars character (NetBox module)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Override with: -e 'sw_character="Leia Organa"'
    sw_character: "Luke Skywalker"
    swapi_base_url: "https://swapi.py4e.com/api"
    netbox_url: "https://demo.netbox.dev"
    netbox_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"

  tasks:
    - name: Validate required NetBox token
      ansible.builtin.assert:
        that:
          - netbox_token | length > 0
        fail_msg: "Set NETBOX_TOKEN before running this playbook."

    - name: Fetch character from SWAPI by name
      ansible.builtin.uri:
        url: "{{ swapi_base_url }}/people/?search={{ sw_character | urlencode }}"
        method: GET
        return_content: true
        status_code: 200
      register: swapi_search

    - name: Ensure at least one character matched the input
      ansible.builtin.assert:
        that:
          - swapi_search.json.count | int > 0
        fail_msg: "No Star Wars character found for input: {{ sw_character }}"

    - name: Select first matched character
      ansible.builtin.set_fact:
        selected_character: "{{ swapi_search.json.results[0] }}"

    - name: Ensure contact exists in NetBox using collection module
      netbox.netbox.netbox_contact:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        data:
          name: "{{ selected_character.name }}"
          title: "Star Wars Character"
          comments: >-
            Created by Ansible demo via netbox.netbox module.
            Height={{ selected_character.height }},
            Birth year={{ selected_character.birth_year }}
        state: present
      register: netbox_contact_result
      no_log: true

    - name: Show module result summary
      ansible.builtin.debug:
        msg:
          - "Input character: {{ sw_character }}"
          - "Contact name in NetBox: {{ selected_character.name }}"
          - "Changed: {{ netbox_contact_result.changed }}"
